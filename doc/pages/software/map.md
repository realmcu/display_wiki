# 地图方案

基于地图的显示应用开发，针对机车仪表盘（Cluster）BLE 传输场景的向量地图格式转换评估。

## 核心对比：四种传输方案（BLE 带宽 30 KB/s）

| 方案           | 单张大小     | BLE传输时间 | 理论帧率  | 缩放质量 | 仪表端负载       | BLE可行性  |
|----------------|--------------|-------------|-----------|----------|------------------|------------|
| **原始 SVG**   | 20.8 KB      | 693 ms      | 1.4 FPS   | 无损     | 极高（XML解析）  | ✗ 不可行   |
| **JPG 光栅图** | 4.4 KB       | 147 ms      | 6.8 FPS   | 会模糊   | 低（硬解码）     | △ 勉强     |
| **二进制向量** | 3.8 KB       | 127 ms      | 7.9 FPS   | 无损     | 中（绘图引擎）   | △ 勉强     |
| **增量向量**   | 0.3-0.5 KB   | 10-17 ms    | 30+ FPS   | 无损     | 中               | ✓ 推荐     |

### 关键结论

- **JPG vs 二进制向量**：大小相近（JPG 略大 15%），但向量可无损缩放
- **完整帧传输**：无论 JPG 还是向量，都会占满 BLE 带宽，无余量给其他数据
- **增量传输**：可将带宽占用降至 17%，留出 80% 给通知、状态等数据

## 增量向量技术方案（推荐）

### 技术原理

增量向量不传完整地图，只传**帧间变化量**：

| 传输内容         | 数据结构                    | 大小估算   |
|------------------|----------------------------|------------|
| 地图偏移量       | int16 dx, dy               | 4 B        |
| 可见图块 ID      | uint8[] tile_ids (约5-10个)| 10-20 B    |
| 导航路径         | int16[] points (关键点)    | 50-200 B   |
| 图标指令         | uint8 id + int8 rotation   | 3-10 B     |
| 状态标志         | uint8 flags                | 1 B        |
| **单帧总计**     |                            | **~300 B** |

### 工作流程

```
帧 N:   手机计算完整地图 → 提取关键数据 → 编码 300B → BLE发送
帧 N+1: 检测变化 → 只编码差异部分 → 可能仅 50-100B
```

### 可行性分析

| 评估维度         | 结论                                              |
|------------------|---------------------------------------------------|
| **BLE 带宽**     | ✓ 300B/帧 × 30FPS = 9KB/s，仅占带宽 30%           |
| **延迟**         | ✓ 10ms 传输 + 5ms 渲染 = 15ms，满足实时性         |
| **MCU 算力**     | ✓ 只需拼接预载图块 + 绘制折线，VG-Lite 可胜任     |
| **Flash 占用**   | △ 需预存图块库，约 500KB-2MB                      |
| **开发成本**     | △ 需定义协议 + 双端实现，约 2-4 周                |
| **风险点**       | 图块库覆盖不全时需回退到完整帧传输                |

### 适用条件

- MCU 带 2D 加速（VG-Lite / GPU）
- Flash 可分配 1MB+ 给图块库
- 导航场景为主（非全景卫星图）

## 混合架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                        手机端                                │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ 地图 SDK    │ -> │ 简化引擎    │ -> │ 二进制编码  │     │
│  │ (完整地图)  │    │ (提取关键)  │    │ (Protobuf)  │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ BLE (~500 B/帧)
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       仪表端 MCU                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │ 预载图块    │ +  │ 坐标解析    │ -> │ 2D 渲染引擎 │     │
│  │ (Flash)     │    │ (增量数据)  │    │ (VG-Lite)   │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

**传输内容精简为：**
- 地图偏移量: 4 bytes (dx, dy)
- 可见图块 ID 列表: ~20 bytes
- 导航路径坐标: ~100-200 bytes (关键转折点)
- 图标指令: ~10 bytes (Icon_ID + Rotation + Position)

## 样本数据分析

基于 5 张 SVG 瓦片地图（256×256 pt）的评估结果：

### 向量元素统计

| 文件       | 路径数 | 坐标点数 | 矩形 | 文字 | 嵌入图片 | 样式类数 |
|------------|--------|----------|------|------|----------|----------|
| MAP1.svg   | 244    | 1,291    | 1    | 0    | 0        | 8        |
| MAP2.svg   | 282    | 1,534    | 1    | 4    | 1        | 9        |
| MAP3.svg   | 121    | 567      | 1    | 2    | 1        | 9        |
| MAP4.svg   | 49     | 244      | 1    | 3    | 2        | 10       |
| MAP5.svg   | 44     | 423      | 1    | 2    | 2        | 13       |
| **平均**   | **148**| **812**  | **1**| **2.2** | **1.2** | **9.8** |

### 文件大小对比

| 文件       | 原始 SVG   | 二进制向量（预估） | JPG (256×256) | SVG→二进制压缩比 |
|------------|------------|-------------------|---------------|------------------|
| MAP1.svg   | 26,920 B   | 5,984 B           | 3,987 B       | 4.5×             |
| MAP2.svg   | 37,327 B   | 7,098 B           | 6,872 B       | 5.3×             |
| MAP3.svg   | 16,742 B   | 2,739 B           | 4,409 B       | 6.1×             |
| MAP4.svg   | 11,536 B   | 1,247 B           | 2,336 B       | 9.3×             |
| MAP5.svg   | 11,549 B   | 1,968 B           | 4,399 B       | 5.9×             |
| **合计**   | **104,074 B** | **19,036 B**   | **22,003 B**  | **5.5×**         |
| **平均/张**| **20.8 KB**| **3.8 KB**        | **4.4 KB**    | -                |

## 带宽占用分析

```
BLE 总带宽预算: ~30 KB/s (100%)

方案 A - 完整二进制向量:
├── 地图数据: 3.8 KB × 8 FPS = 30.4 KB/s (101%) ← 超载
└── 其他数据: 0 KB/s (无余量)

方案 B - JPG 光栅图:
├── 地图数据: 4.4 KB × 7 FPS = 30.8 KB/s (103%) ← 超载
└── 其他数据: 0 KB/s (无余量)

方案 C - 增量向量 + 预载图块 (推荐):
├── 增量数据: 0.5 KB × 10 FPS = 5 KB/s (17%)
├── 导航指令: 0.1 KB × 10 FPS = 1 KB/s (3%)
└── 其他数据: 24 KB/s (80%) ← 充足余量
```

## 结论与下一步

| 结论项               | 说明                                           |
|----------------------|------------------------------------------------|
| **当前 SVG 复杂度**  | 中高（平均 812 坐标点/张）                     |
| **直接传输可行性**   | 二进制向量勉强可行，但无带宽余量               |
| **推荐方案**         | 混合架构：预载图块 + 增量坐标传输              |
| **预期效果**         | 单帧 < 500 B，帧率 30+ FPS，带宽占用 < 20%     |

### 下一步行动

1. **定义二进制协议** - 设计 Protobuf schema 或 TinyVG 子集
2. **图块预处理** - 将常用地图元素切分为可复用图块
3. **增量算法** - 实现帧间差异检测，只传变化部分
4. **仪表端适配** - 确认 MCU 的 2D 渲染能力（VG-Lite / BitBLT）

## 示例代码

```c
// 初始化地图系统
map_init();

// 设置地图中心和缩放级别
map_set_center(lat, lon);
map_set_zoom(level);

// 增量更新示例
map_update_delta(dx, dy, tile_ids, path_points);
```

---

**注意：** 本页面内容为初始评估版本，后续将进行实际校验和可行性分析。

*评估日期: 2026-02-04 | 样本数量: 5 张 SVG 瓦片地图*
